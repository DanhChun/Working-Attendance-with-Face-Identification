import requests
from datetime import datetime
import json
import numpy as np

# Map nhãn danh sách → họ tên nhân viên
NAME_MAP = {
    "Mr_Danh": "Chu Cao Danh"
}

PERSON_TO_SHEET = {
    "Mr_Danh": {
        "sheet_name": "DanhCC",
        "telegram_token": "...",
        "telegram_chat_id": "...",
        "position": "...",
        "department": "..."
    }
}

APPS_SCRIPT_URL = "" put app URL apps script here


def handle_result(name, status, location, mode):
    routed_name = None
    for key, val in NAME_MAP.items():
        if val == name:
            routed_name = key
            break

    if not routed_name or routed_name not in PERSON_TO_SHEET:
        print(f"⚠️ Không map được {name}")
        return

    sheet_info = PERSON_TO_SHEET[routed_name] 
    data = {
        "name": name,
        "position": sheet_info.get("position", "UNKNOWN"),
        "status": status,
        "location": location,
        "sheet": sheet_info["sheet_name"],
        "department": sheet_info.get("department"),
        "mode": mode
    }

    def convert_data(obj):
        if isinstance(obj, (np.float32, np.float64)):
            return float(obj)
        if isinstance(obj, (np.int32, np.int64)):
            return int(obj)
        if isinstance(obj, np.ndarray):
            return obj.tolist()
        return obj
    
    clean_data = {k: convert_data(v) for k, v in data.items()}

    try:
        r = requests.post(APPS_SCRIPT_URL,
                         json=clean_data,
                         headers={"Content-Type": "application/json"},
                         timeout=20)
        print(f"Gửi Apps Script: {r.status_code}, Trả về: {r.text}")

    except requests.RequestException as e:
        print(f"lỗi network khi gọi GAS: {e}")
        raise
    except Exception as e:
        print(f" Lỗi xử lý: {e}")
        raise
